let r=null,i={title:"",excerpt:"",content:"",isPublished:!1,readTime:1};function m(e={}){console.log("Инициализация страницы статей..."),Object.assign(i,e),u(),a(),console.log("Страница статей инициализирована")}function u(){console.log("Инициализация обработчиков событий...");const e=document.querySelector(".editable-title"),t=document.querySelector(".editable-excerpt"),n=document.querySelector(".editable-content");e&&(e.addEventListener("input",g),e.addEventListener("keydown",h),e.addEventListener("paste",d)),t&&(t.addEventListener("input",f),t.addEventListener("keydown",w),t.addEventListener("paste",d)),n&&(n.addEventListener("input",p),n.addEventListener("paste",d));const o=document.getElementById("hidden-image");o&&o.addEventListener("change",E),console.log("Обработчики событий инициализированы")}function g(e){const t=e.target.textContent.trim()||"";i.title=t,a(),s()}function f(e){const t=e.target.textContent.trim()||"";i.excerpt=t,a(),s()}function p(e){const t=e.target.innerHTML.trim()||"";i.content=t,a(),s()}function h(e){e.target.textContent.length>=150&&e.keyCode!==8&&e.keyCode!==46&&e.preventDefault()}function w(e){e.target.textContent.length>=300&&e.keyCode!==8&&e.keyCode!==46&&e.preventDefault()}function d(e){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text");document.execCommand("insertText",!1,t)}function y(e){const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)}function v(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=function(t){const n=t.target.files[0];n&&c(n)},e.click()}function c(e){if(!e.type.startsWith("image/")){showUploadError("Пожалуйста, выберите файл изображения");return}if(e.size>10*1024*1024){showUploadError("Размер файла не должен превышать 10MB");return}r=e;const t=document.getElementById("article-image-container")||document.querySelector(".article-image");if(t)if(t.innerHTML=`
            <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Создание превью...</span>
                </div>
                <span class="ms-2">Обработка изображения...</span>
            </div>
        `,window.createOptimizedPreview)window.createOptimizedPreview(e,null,function(o,l){t.innerHTML=`
                    <img src="${l}" alt="Изображение статьи" class="img-fluid rounded">
                    <div class="image-overlay">
                        <i class="bi bi-camera-fill"></i>
                        <span>Изменить изображение</span>
                    </div>
                `});else{const o=new FileReader;o.onload=function(l){t.innerHTML=`
                    <img src="${l.target.result}" alt="Изображение статьи" class="img-fluid rounded">
                    <div class="image-overlay">
                        <i class="bi bi-camera-fill"></i>
                        <span>Изменить изображение</span>
                    </div>
                `},o.readAsDataURL(e)}const n=document.getElementById("hidden-image");if(n){const o=new DataTransfer;o.items.add(e),n.files=o.files}}function E(e){const t=e.target.files[0];t&&c(t)}function s(){const t=i.content.replace(/<[^>]*>/g,"").split(/\s+/).filter(l=>l.length>0).length,n=Math.max(1,Math.ceil(t/200));i.readTime=n;const o=document.querySelector(".read-time");o&&(o.textContent=`${n} мин чтения`),a()}function a(){const e=document.getElementById("hidden-title"),t=document.getElementById("hidden-excerpt"),n=document.getElementById("hidden-content"),o=document.getElementById("hidden-read-time"),l=document.getElementById("hidden-is-published");e&&(e.value=i.title),t&&(t.value=i.excerpt),n&&(n.value=i.content),o&&(o.value=i.readTime),l&&(l.value=i.isPublished?"1":"0")}function x(e=!1){const t=[];return(!i.title.trim()||i.title==="Новая статья")&&t.push("Пожалуйста, введите заголовок статьи"),(!i.excerpt.trim()||i.excerpt==="Краткое описание статьи. Нажмите, чтобы редактировать.")&&t.push("Пожалуйста, введите краткое описание статьи"),(!i.content.trim()||i.content==="<p>Содержание статьи. Нажмите, чтобы начать писать...</p>")&&t.push("Пожалуйста, введите содержание статьи"),t.length>0?(alert(t.join(`
`)),!1):!0}function L(e=!1){if(console.log("Сохранение статьи...",{publish:e}),!x(e))return;const t=window.simulateUploadProgress?window.simulateUploadProgress(3e3):null;i.isPublished=e,a();const n=document.getElementById("article-form");n?r&&r.size>1024*1024?setTimeout(()=>{window.completeUploadProgress&&window.completeUploadProgress(),n.submit()},1500):setTimeout(()=>{window.completeUploadProgress&&window.completeUploadProgress(),n.submit()},800):(window.showUploadError?window.showUploadError("Ошибка: форма не найдена"):alert("Ошибка: форма не найдена"),t&&clearInterval(t),window.hideProgressBar&&window.hideProgressBar())}function T(){const e=document.getElementById("loading-overlay");e&&(e.style.display="flex")}function b(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}document.addEventListener("beforeunload",function(){a()});window.initArticlePage=m;window.selectText=y;window.selectImage=v;window.saveArticle=L;window.showArticleLoading=T;window.hideArticleLoading=b;console.log("Модуль admin-articles.js загружен");
