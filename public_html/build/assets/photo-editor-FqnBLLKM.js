var y=(m,e)=>()=>(e||m((e={exports:{}}).exports,e),e.exports);var S=y((f,u)=>{class p{constructor(){this.modal=null,this.image=null,this.canvas=null,this.ctx=null,this.currentFormat=null,this.currentStep=1,this.maxSteps=2,this.editType=null,this.imageState={x:0,y:0,scale:1,rotation:0,isDragging:!1,isResizing:!1,dragStart:{x:0,y:0},resizeHandle:null,touches:[],initialDistance:0,initialScale:1,isPinching:!1,pinchCenter:{x:0,y:0}},this.formats={reel:{width:405,height:720,ratio:9/16,name:"Рилс (9:16)",outputWidth:1080,outputHeight:1920},desktop:{width:640,height:360,ratio:16/9,name:"Десктоп (16:9)",outputWidth:1920,outputHeight:1080},square:{width:480,height:480,ratio:1,name:"Квадрат (1:1)",outputWidth:1080,outputHeight:1080}},this.init()}init(){console.log("PhotoEditor: Initialized without creating modal (lazy loading)")}createModal(){document.body.insertAdjacentHTML("beforeend",`
            <div class="photo-editor-modal" id="photoEditorModal">
                <div class="photo-editor-content">
                    <div class="photo-editor-header">
                        <button class="photo-editor-close" id="closeEditor">&times;</button>
                    </div>
                    
                    <div class="photo-editor-steps" id="editorSteps" style="display: none;">
                        <div class="step-indicator" id="step1">
                            <span>Рилс (9:16)</span>
                        </div>
                        <div class="step-indicator" id="step2">
                            <span>Десктоп (16:9)</span>
                        </div>
                    </div>
                    
                    <div class="photo-editor-body">
                        <div class="editor-toolbar">
                            <div class="toolbar-section">
                                <div class="action-buttons">
                                  
                                        <input type="file" id="imageInput" class="file-input" accept="image/*">
                                        <label for="imageInput" class="file-input-button">
                                             Файл
                                        </label>
                                 
                                    <button class="action-button secondary" id="resetButton">Сбросить</button>
                                    <button class="action-button primary" id="cropButton" disabled>
                                        <span id="cropButtonText">Обрезать</span>
                                    </button>
                                    <button class="action-button primary" id="nextStepButton" style="display: none;">
                                        Следующий этап
                                    </button>
                                    <button class="action-button primary" id="saveButton" style="display: none;">
                                        Сохранить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="editor-canvas-area">
                            <div class="format-container" id="formatContainer">
                                <canvas id="editorCanvas" style="display: none;"></canvas>
                                <img id="editorImage" class="editor-image" style="display: none;">
                                
                                <div class="resize-handles" id="resizeHandles" style="display: none;">
                                    <div class="resize-handle nw" data-handle="nw"></div>
                                    <div class="resize-handle ne" data-handle="ne"></div>
                                    <div class="resize-handle sw" data-handle="sw"></div>
                                    <div class="resize-handle se" data-handle="se"></div>

                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="editor-loader" id="editorLoader">
                        <div class="loader-spinner"></div>
                        <div>Обработка изображения...</div>
                    </div>
                </div>
            </div>
        `),this.modal=document.getElementById("photoEditorModal")}bindEvents(){document.getElementById("closeEditor").addEventListener("click",()=>this.close()),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.close()}),document.getElementById("imageInput").addEventListener("change",e=>this.loadImage(e)),document.getElementById("resetButton").addEventListener("click",()=>this.resetImage()),document.getElementById("cropButton").addEventListener("click",()=>this.cropImage()),document.getElementById("nextStepButton").addEventListener("click",()=>this.nextStep()),document.getElementById("saveButton").addEventListener("click",()=>this.saveImages())}bindImageEvents(){const e=document.getElementById("editorImage"),i=document.getElementById("formatContainer");!e||!i||(this.imageEventHandlers={mousedown:t=>this.startDrag(t),mousemove:t=>this.drag(t),mouseup:()=>this.endDrag(),touchstart:t=>this.handleTouchStart(t),touchmove:t=>this.handleTouchMove(t),touchend:t=>this.handleTouchEnd(t),wheel:t=>this.handleWheel(t)},e.addEventListener("mousedown",this.imageEventHandlers.mousedown),document.addEventListener("mousemove",this.imageEventHandlers.mousemove),document.addEventListener("mouseup",this.imageEventHandlers.mouseup),i.addEventListener("touchstart",this.imageEventHandlers.touchstart,{passive:!0}),i.addEventListener("touchmove",this.imageEventHandlers.touchmove,{passive:!0}),i.addEventListener("touchend",this.imageEventHandlers.touchend,{passive:!0}),i.addEventListener("wheel",this.imageEventHandlers.wheel,{passive:!1}),this.bindResizeHandles())}unbindImageEvents(){const e=document.getElementById("editorImage"),i=document.getElementById("formatContainer");this.imageEventHandlers&&(e&&e.removeEventListener("mousedown",this.imageEventHandlers.mousedown),i&&(i.removeEventListener("touchstart",this.imageEventHandlers.touchstart),i.removeEventListener("touchmove",this.imageEventHandlers.touchmove),i.removeEventListener("touchend",this.imageEventHandlers.touchend),i.removeEventListener("wheel",this.imageEventHandlers.wheel)),document.removeEventListener("mousemove",this.imageEventHandlers.mousemove),document.removeEventListener("mouseup",this.imageEventHandlers.mouseup),this.unbindResizeHandles(),this.imageEventHandlers=null)}bindResizeHandles(){if(window.matchMedia("(pointer: coarse)").matches||window.innerWidth<=768)return;this.resizeEventHandlers={mousemove:i=>this.resize(i),mouseup:()=>this.endResize(),touchend:()=>this.endResize()},document.querySelectorAll(".resize-handle").forEach(i=>{i.addEventListener("mousedown",t=>this.startResize(t))}),document.addEventListener("mousemove",this.resizeEventHandlers.mousemove),document.addEventListener("mouseup",this.resizeEventHandlers.mouseup),document.addEventListener("touchend",this.resizeEventHandlers.touchend)}unbindResizeHandles(){this.resizeEventHandlers&&(document.removeEventListener("mousemove",this.resizeEventHandlers.mousemove),document.removeEventListener("mouseup",this.resizeEventHandlers.mouseup),document.removeEventListener("touchend",this.resizeEventHandlers.touchend),this.resizeEventHandlers=null)}open(e){this.modal||(console.log("PhotoEditor: Creating modal on first open"),this.createModal(),this.bindEvents()),this.editType=e,this.currentStep=1;const i=document.getElementById("editorSteps");e==="hero"?(i.style.display="flex",this.maxSteps=2,this.setFormat("reel")):e==="avatar"&&(i.style.display="none",this.maxSteps=1,this.setFormat("square")),this.updateStepIndicators(),this.modal.classList.add("show"),document.body.classList.add("modal-open"),this.bindImageEvents(),this.addModalSwipeToClose(),this.keyboardHandler=t=>this.handleKeyboard(t),document.addEventListener("keydown",this.keyboardHandler)}close(){if(!this.modal){console.log("PhotoEditor: Modal not created yet, nothing to close");return}this.modal.classList.remove("show"),document.body.classList.remove("modal-open"),this.unbindImageEvents(),this.removeModalSwipeToClose(),this.keyboardHandler&&(document.removeEventListener("keydown",this.keyboardHandler),this.keyboardHandler=null),this.resetEditor()}setFormat(e){this.currentFormat=e;const i=document.getElementById("formatContainer");this.formats[e],i.classList.remove("reel","desktop","square"),i.classList.add(e),this.image&&this.updateImageDisplay()}loadImage(e){const i=e.target.files[0];if(!i)return;if(!i.type.startsWith("image/")){alert("Пожалуйста, выберите файл изображения");return}if(i.size>10*1024*1024){alert("Размер файла не должен превышать 10MB");return}const t=new FileReader;t.onload=s=>{this.image=new Image,this.image.onload=()=>{this.setupImage()},this.image.src=s.target.result},t.readAsDataURL(i)}setupImage(){const e=document.getElementById("editorImage"),i=document.getElementById("formatContainer"),t=document.getElementById("resizeHandles");e.src=this.image.src,e.style.display="block",t.style.display="block",i.classList.add("has-image"),this.resetImageState(),this.autoFitImage(),document.getElementById("cropButton").disabled=!1;const s=document.querySelector(".editor-hint");s&&(s.textContent="Перетащите и масштабируйте изображение")}autoFitImage(){setTimeout(()=>{const e=document.getElementById("formatContainer"),i=e.getBoundingClientRect();let t=i.width,s=i.height;if(t===0||s===0){const r=window.getComputedStyle(e);t=parseInt(r.width)||this.formats[this.currentFormat].width,s=parseInt(r.height)||this.formats[this.currentFormat].height}console.log("Container dimensions:",t,"x",s),console.log("Image dimensions:",this.image.width,"x",this.image.height);const a=t/this.image.width,n=s/this.image.height,o=Math.max(a,n);console.log("Calculated scale:",o),this.imageState.scale=o,this.imageState.x=0,this.imageState.y=0,this.imageState.rotation=0,this.updateImageDisplay()},100)}resetImageState(){this.imageState={x:0,y:0,scale:1,rotation:0,isDragging:!1,isResizing:!1,dragStart:{x:0,y:0},resizeHandle:null,touches:[],initialDistance:0,initialScale:1,isPinching:!1,pinchCenter:{x:0,y:0}}}updateImageDisplay(){const e=document.getElementById("editorImage"),i=`translate(-50%, -50%) 
                          translate(${this.imageState.x}px, ${this.imageState.y}px) 
                          scale(${this.imageState.scale}) 
                          rotate(${this.imageState.rotation}deg)`;e.style.transform=i,e.style.width=this.image.width+"px",e.style.height=this.image.height+"px",e.style.top="50%",e.style.left="50%"}startDrag(e){if(this.imageState.isResizing)return;e.preventDefault(),this.imageState.isDragging=!0;const i=e.touches?e.touches[0].clientX:e.clientX,t=e.touches?e.touches[0].clientY:e.clientY;this.imageState.dragStart={x:i-this.imageState.x,y:t-this.imageState.y},document.getElementById("editorImage").classList.add("dragging")}drag(e){if(!this.imageState.isDragging||this.imageState.isResizing)return;e.preventDefault();const i=e.touches?e.touches[0].clientX:e.clientX,t=e.touches?e.touches[0].clientY:e.clientY;this.imageState.x=i-this.imageState.dragStart.x,this.imageState.y=t-this.imageState.dragStart.y,this.updateImageDisplay()}endDrag(){this.imageState.isDragging=!1,document.getElementById("editorImage").classList.remove("dragging")}startResize(e){e.preventDefault(),e.stopPropagation(),this.imageState.isResizing=!0,this.imageState.resizeHandle=e.target.dataset.handle;const i=e.touches?e.touches[0].clientX:e.clientX,t=e.touches?e.touches[0].clientY:e.clientY;this.imageState.dragStart={x:i,y:t},this.imageState.startScale=this.imageState.scale}resize(e){if(!this.imageState.isResizing)return;e.preventDefault();const i=e.touches?e.touches[0].clientX:e.clientX,t=e.touches?e.touches[0].clientY:e.clientY,s=i-this.imageState.dragStart.x,a=t-this.imageState.dragStart.y,n=Math.sqrt(s*s+a*a),o=this.imageState.resizeHandle;let r=1;o==="se"||o==="nw"?r=s+a>0?1.01:.99:r=s-a>0?1.01:.99;const d=Math.max(.1,Math.min(3,this.imageState.startScale*Math.pow(r,n/10)));this.imageState.scale=d,this.updateImageDisplay()}endResize(){this.imageState.isResizing=!1,this.imageState.resizeHandle=null}handleWheel(e){if(!this.image)return;e.preventDefault();const i=e.deltaY>0?-.1:.1,t=Math.max(.1,Math.min(3,this.imageState.scale+i));this.imageState.scale=t,this.updateImageDisplay()}handleKeyboard(e){if(!this.modal||!this.modal.classList.contains("show")||!this.image)return;const i=e.shiftKey?10:1;switch(e.key){case"ArrowLeft":e.preventDefault(),this.imageState.x-=i;break;case"ArrowRight":e.preventDefault(),this.imageState.x+=i;break;case"ArrowUp":e.preventDefault(),this.imageState.y-=i;break;case"ArrowDown":e.preventDefault(),this.imageState.y+=i;break;case"Escape":this.close();return;default:return}this.updateImageDisplay()}handleTouchStart(e){const i=document.getElementById("formatContainer");if(!i||!i.contains(e.target)&&e.target!==i||!this.image)return;const t=Array.from(e.touches);if(this.imageState.touches=t,t.length===1){const s=t[0];this.imageState.isDragging=!0,this.imageState.dragStart={x:s.clientX-this.imageState.x,y:s.clientY-this.imageState.y}}else t.length===2&&(this.imageState.isPinching=!0,this.imageState.isDragging=!1,this.imageState.initialDistance=this.getTouchDistance(t[0],t[1]),this.imageState.initialScale=this.imageState.scale,this.imageState.pinchCenter=this.getTouchCenter(t[0],t[1]))}handleTouchMove(e){if(!this.imageState.isDragging&&!this.imageState.isPinching||!document.getElementById("formatContainer")||!this.image)return;const t=Array.from(e.touches);if(t.length===1&&this.imageState.isDragging&&!this.imageState.isPinching){const s=t[0];this.imageState.x=s.clientX-this.imageState.dragStart.x,this.imageState.y=s.clientY-this.imageState.dragStart.y,this.updateImageDisplay()}else if(t.length===2&&this.imageState.isPinching){const a=this.getTouchDistance(t[0],t[1])/this.imageState.initialDistance,n=Math.max(.1,Math.min(5,this.imageState.initialScale*a));if(n!==this.imageState.scale){const o=this.getTouchCenter(t[0],t[1]),d=document.getElementById("formatContainer").getBoundingClientRect(),l=o.x-d.left,c=o.y-d.top,h=this.imageState.scale,g=n/h;this.imageState.x=l-(l-this.imageState.x)*g,this.imageState.y=c-(c-this.imageState.y)*g,this.imageState.scale=n,this.updateImageDisplay()}}}handleTouchEnd(e){if(e.touches.length===0)this.imageState.isDragging=!1,this.imageState.isPinching=!1,this.imageState.touches=[];else if(e.touches.length===1&&this.imageState.isPinching){this.imageState.isPinching=!1;const i=e.touches[0];this.imageState.isDragging=!0,this.imageState.dragStart={x:i.clientX-this.imageState.x,y:i.clientY-this.imageState.y}}}getTouchDistance(e,i){const t=i.clientX-e.clientX,s=i.clientY-e.clientY;return Math.sqrt(t*t+s*s)}getTouchCenter(e,i){return{x:(e.clientX+i.clientX)/2,y:(e.clientY+i.clientY)/2}}resetImage(){this.image&&this.autoFitImage()}cropImage(){this.image&&(this.showLoader(),setTimeout(()=>{const e=this.createCroppedCanvas();let i=.9;this.currentFormat==="desktop"?i=.92:this.currentFormat==="reel"&&(i=.88);const t=e.toDataURL("image/webp",i);this.editType==="hero"&&this.currentStep<this.maxSteps?(this.saveStepResult(this.currentStep,t),this.nextStep()):(this.saveStepResult(this.currentStep,t),this.showSaveButton()),this.hideLoader()},500))}createCroppedCanvas(){const e=this.formats[this.currentFormat],i=document.getElementById("formatContainer"),t=document.createElement("canvas"),s=t.getContext("2d"),a=i.getBoundingClientRect(),n=a.width,o=a.height,r=e.outputWidth||e.width,d=e.outputHeight||e.height;console.log("Cropping - Container:",n,"x",o),console.log("Cropping - Output:",r,"x",d),console.log("Cropping - Scale factors:",r/n,"x",d/o),t.width=r,t.height=d,s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const l=r/n,c=d/o;return s.save(),s.translate(r/2,d/2),s.translate(this.imageState.x*l,this.imageState.y*c),s.scale(this.imageState.scale*l,this.imageState.scale*c),s.rotate(this.imageState.rotation*Math.PI/180),s.drawImage(this.image,-this.image.width/2,-this.image.height/2),s.restore(),t}nextStep(){this.currentStep>=this.maxSteps||(this.currentStep++,this.editType==="hero"&&this.currentStep===2&&(this.setFormat("desktop"),this.updateStepIndicators(),this.image&&this.autoFitImage(),document.getElementById("nextStepButton").style.display="none",document.getElementById("cropButton").style.display="block",document.getElementById("cropButtonText").textContent="Обрезать"))}updateStepIndicators(){if(this.editType==="hero")for(let e=1;e<=this.maxSteps;e++){const i=document.getElementById(`step${e}`);i&&i.classList.toggle("active",e===this.currentStep)}}saveStepResult(e,i){const t=JSON.parse(localStorage.getItem("photoEditorResults")||"{}");this.editType==="hero"?(t.hero||(t.hero={}),t.hero[e===1?"reel":"desktop"]=i):this.editType==="avatar"&&(t.avatar=i),localStorage.setItem("photoEditorResults",JSON.stringify(t))}showSaveButton(){document.getElementById("cropButton").style.display="none",document.getElementById("saveButton").style.display="block"}async saveImages(){const e=JSON.parse(localStorage.getItem("photoEditorResults")||"{}");if(console.log("PhotoEditor: Saving images...",{type:this.editType,results:e}),Object.keys(e).length===0){alert("Нет данных для сохранения");return}const i=document.querySelector('meta[name="csrf-token"]');if(!i){alert("❌ Ошибка: пользователь не авторизован");return}this.showLoader();try{const t=new FormData;t.append("_token",i.getAttribute("content")),t.append("type",this.editType);for(const[o,r]of Object.entries(e))if(typeof r=="object")for(const[d,l]of Object.entries(r)){const c=this.dataURLtoBlob(l);let h=o;d==="reel"?h="hero_reel":d==="desktop"&&(h="hero_desktop"),t.append(h,c,`${h}.webp`)}else{const d=this.dataURLtoBlob(r);t.append(o,d,`${o}.webp`)}const s=await fetch("/photo-editor/save",{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=s.headers.get("content-type");if(!a||!a.includes("application/json")){const o=await s.text();throw console.error("Received non-JSON response:",o),new Error("Сервер вернул некорректный ответ")}const n=await s.json();if(console.log("PhotoEditor: Server response:",n),n.success){this.updateUIAfterSave(n.data),localStorage.removeItem("photoEditorResults");let o="✅ Изображения успешно сохранены!";this.editType==="hero"?o+=`
🖼️ Фон обновлен для ПК и мобильных устройств.`:this.editType==="avatar"&&(o+=`
👤 Аватар обновлен.`),alert(o),this.close(),setTimeout(()=>{confirm("Перезагрузить страницу для полного применения изменений?")&&window.location.reload()},1e3)}else throw new Error(n.message||"Ошибка сохранения")}catch(t){console.error("Ошибка сохранения:",t);let s="Неизвестная ошибка";t.message.includes("HTTP error!")?s="Ошибка сервера. Проверьте авторизацию и попробуйте снова.":t.message.includes("некорректный ответ")?s="Сервер вернул некорректный ответ. Возможно, проблема с маршрутизацией.":s=t.message,alert("❌ Ошибка при сохранении изображений: "+s)}finally{this.hideLoader()}}dataURLtoBlob(e){const i=e.split(","),t=i[0].match(/:(.*?);/)[1],s=atob(i[1]);let a=s.length;const n=new Uint8Array(a);for(;a--;)n[a]=s.charCodeAt(a);return new Blob([n],{type:t})}updateUIAfterSave(e){if(this.editType==="hero"){const i=document.querySelector(".hero");if(i&&(e.hero_desktop||e.hero_reel)){console.log("PhotoEditor: Updating hero background...",e),document.querySelectorAll('style[data-photo-editor="hero"]').forEach(r=>r.remove());const s=document.createElement("style");s.setAttribute("data-photo-editor","hero");const a=e.hero_desktop||e.hero_reel,n=e.hero_reel||e.hero_desktop;s.textContent=`
                    .hero {
                        background-image: url('${a}?t=${Date.now()}') !important;
                    }
                    
                    @media (max-width: 768px) {
                        .hero {
                            background-image: url('${n}?t=${Date.now()}') !important;
                        }
                    }
                `,document.head.appendChild(s),i.style.backgroundImage=`url('${a}?t=${Date.now()}')`;const o=document.querySelector(".hero + style, .hero style, section.hero + style");if(o){console.log("PhotoEditor: Updating inline hero styles");const r=o.textContent;o.textContent=r.replace(/background-image:\s*url\([^)]+\)/g,`background-image: url('${a}?t=${Date.now()}')`)}console.log("PhotoEditor: Hero background updated successfully")}else console.warn("PhotoEditor: Hero section not found or no images provided")}else if(this.editType==="avatar"){console.log("PhotoEditor: Updating avatar...",e);const i=[".hero-logo img",".hero-logo x-optimized-image img",".avatar img",".user-avatar img",'img[class*="avatar"]','img[class*="hero-logo"]',".hero .hero-logo img"];let t=!1;for(const s of i){const a=document.querySelector(s);if(console.log(`PhotoEditor: Checking selector "${s}":`,a),a&&e.avatar){const n=a.src;a.src=e.avatar+"?t="+Date.now(),t=!0,console.log("PhotoEditor: Avatar updated!",{selector:s,oldSrc:n,newSrc:a.src});break}}t||(console.warn("PhotoEditor: Avatar element not found!"),console.log("PhotoEditor: Available selectors searched:",i),console.log("PhotoEditor: All images on page:",document.querySelectorAll("img")),console.log("PhotoEditor: .hero-logo element:",document.querySelector(".hero-logo")))}}showLoader(){document.getElementById("editorLoader").classList.add("show")}hideLoader(){document.getElementById("editorLoader").classList.remove("show")}addModalSwipeToClose(){if(!this.modal){console.log("PhotoEditor: Modal not created, cannot add swipe handlers");return}let e=0,i=0,t=!1;this.swipeHandlers={touchstart:s=>{const a=document.getElementById("formatContainer");a&&(a.contains(s.target)||s.target===a)||(e=s.touches[0].clientY,i=Date.now(),t=!0)},touchmove:s=>{if(!t)return;s.touches[0].clientY-e<50&&(t=!1)},touchend:s=>{if(!t)return;const n=s.changedTouches[0].clientY-e,o=Date.now()-i;(n>100||n>50&&o<300)&&this.close(),t=!1}},this.modal.addEventListener("touchstart",this.swipeHandlers.touchstart,{passive:!0}),this.modal.addEventListener("touchmove",this.swipeHandlers.touchmove,{passive:!0}),this.modal.addEventListener("touchend",this.swipeHandlers.touchend,{passive:!0})}removeModalSwipeToClose(){!this.swipeHandlers||!this.modal||(this.modal.removeEventListener("touchstart",this.swipeHandlers.touchstart),this.modal.removeEventListener("touchmove",this.swipeHandlers.touchmove),this.modal.removeEventListener("touchend",this.swipeHandlers.touchend),this.swipeHandlers=null)}resetEditor(){this.image=null,this.currentFormat=null,this.currentStep=1,this.editType=null;const e=document.getElementById("editorImage"),i=document.getElementById("formatContainer"),t=document.getElementById("resizeHandles"),s=document.getElementById("imageInput");e&&(e.style.display="none",e.src=""),t&&(t.style.display="none"),i&&i.classList.remove("has-image","reel","desktop","square"),s&&(s.value="");const a=document.getElementById("cropButton"),n=document.getElementById("nextStepButton"),o=document.getElementById("saveButton"),r=document.getElementById("cropButtonText");a&&(a.disabled=!0,a.style.display="block"),n&&(n.style.display="none"),o&&(o.style.display="none"),r&&(r.textContent="Обрезать"),this.resetImageState();const d=document.querySelector(".editor-hint");d&&(d.textContent="")}}document.addEventListener("DOMContentLoaded",function(){window.photoEditor=new p});window.openPhotoEditor=function(m){window.photoEditor?window.photoEditor.open(m):setTimeout(()=>{window.photoEditor&&window.photoEditor.open(m)},100)};typeof u<"u"&&u.exports&&(u.exports=p)});export default S();
