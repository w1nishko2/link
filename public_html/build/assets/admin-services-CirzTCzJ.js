let a=null,n={};function u(i={}){n={title:"",description:"",price:"",priceType:"fixed",hasPrice:!1,buttonText:"Заказать",...i},g(),v(),n.hasPrice&&n.price&&(document.querySelector(".service-price").style.display="block",y())}function g(){document.querySelector(".services-swiper")&&new Swiper(".services-swiper",{slidesPerView:1,spaceBetween:20,loop:!1,navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},pagination:{el:".swiper-pagination",clickable:!0},breakpoints:{768:{slidesPerView:2,spaceBetween:30},1024:{slidesPerView:3,spaceBetween:30}}})}function v(){document.querySelectorAll('[contenteditable="true"]').forEach(s=>{s.addEventListener("input",b),s.addEventListener("blur",w)});const e=document.getElementById("image-input");e&&e.addEventListener("change",s=>{handleImageSelect(s,"image-preview",(r,o)=>{a=r,d()})});const t=document.getElementById("service-form");t&&t.addEventListener("submit",h)}function b(i){const e=i.target,t=e.getAttribute("data-field");t&&n.hasOwnProperty(t)&&(n[t]=e.textContent.trim())}function w(i){const e=i.target;e.getAttribute("data-field")==="price"&&f(e)}function f(i){let e=i.textContent.trim();e=e.replace(/[^\d.,]/g,""),e=e.replace(",",".");const t=e.split(".");t.length>2&&(e=t[0]+"."+t[1]),t[1]&&t[1].length>2&&(e=t[0]+"."+t[1].substring(0,2)),i.textContent=e,n.price=e}function y(i){const e=document.getElementById("price-toggle");e&&(e.innerHTML='<i class="bi bi-dash"></i> Убрать цену',e.className="btn btn-outline-danger btn-sm")}function d(){document.querySelectorAll('[contenteditable="true"]').forEach(t=>{const s=t.getAttribute("data-field");s&&n.hasOwnProperty(s)&&(n[s]=t.textContent.trim())});const e=document.querySelector(".service-price");n.hasPrice=e&&e.style.display!=="none"}async function h(i){var s;if(i.preventDefault(),!l())return;d();const e=new FormData;Object.keys(n).forEach(r=>{n[r]!==null&&n[r]!==void 0&&e.append(r,n[r])}),a&&e.append("image",a);const t=(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content");t&&e.append("_token",t),await submitForm(i.target,{method:"POST",loadingOverlayId:"loadingOverlay",validateBeforeSubmit:l,onSuccess:r=>{r.redirect_url&&(window.location.href=r.redirect_url)}})}function l(){if(d(),!n.title||n.title.trim()===""){showNotification("Пожалуйста, введите название услуги","error");const i=document.querySelector('[data-field="title"]');return i&&(i.focus(),i.classList.add("is-invalid"),setTimeout(()=>i.classList.remove("is-invalid"),3e3)),!1}if(!n.description||n.description.trim()===""){showNotification("Пожалуйста, введите описание услуги","error");const i=document.querySelector('[data-field="description"]');return i&&(i.focus(),i.classList.add("is-invalid"),setTimeout(()=>i.classList.remove("is-invalid"),3e3)),!1}if(n.hasPrice&&(!n.price||n.price.trim()==="")){showNotification("Пожалуйста, введите цену услуги","error");const i=document.querySelector('[data-field="price"]');return i&&(i.focus(),i.classList.add("is-invalid"),setTimeout(()=>i.classList.remove("is-invalid"),3e3)),!1}return!0}function m(){typeof Swiper<"u"&&document.querySelector(".services-swiper")&&new Swiper(".services-swiper",{slidesPerView:1,spaceBetween:20,loop:!1,navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},breakpoints:{768:{slidesPerView:1,spaceBetween:30},1024:{slidesPerView:1,spaceBetween:30}}})}function p(){document.querySelectorAll('[contenteditable="true"]').forEach(i=>{i.addEventListener("input",function(){const e=this.getAttribute("data-field"),t=this.textContent.trim();e&&(n[e]=t,c(e,t))}),i.addEventListener("blur",function(){this.getAttribute("data-field")==="price"&&f(this)})}),document.querySelectorAll(".add-price-button").forEach(i=>{i.addEventListener("click",function(){const e=this.getAttribute("data-service-id"),t=document.querySelector(`.service-price[data-service-id="${e}"]`);t.style.display==="none"||!t.style.display?(t.style.display="block",this.innerHTML='<i class="bi bi-dash"></i> Убрать',this.classList.remove("btn-outline-success"),this.classList.add("btn-outline-danger")):(t.style.display="none",this.innerHTML='<i class="bi bi-plus"></i> Цена',this.classList.remove("btn-outline-danger"),this.classList.add("btn-outline-success"))})}),document.querySelectorAll(".editable-image").forEach(i=>{i.addEventListener("click",function(){const e=this.getAttribute("data-service-id"),t=document.createElement("input");t.type="file",t.accept="image/*",t.addEventListener("change",function(s){if(s.target.files&&s.target.files[0]){const r=s.target.files[0];E(e,r)}}),t.click()})}),document.querySelectorAll(".editable-button").forEach(i=>{i.addEventListener("click",function(){const e=this.querySelector("span");if(e){e.contentEditable=!0,e.focus();const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t),e.addEventListener("blur",function(){this.contentEditable=!1;const r=i.getAttribute("data-service-id"),o=this.textContent.trim();c("buttonText",o,r)},{once:!0}),e.addEventListener("keydown",function(r){r.key==="Enter"&&(r.preventDefault(),this.blur())})}})})}function E(i,e){const t=new FileReader;t.onload=function(s){const r=document.querySelector(`.service-image[data-service-id="${i}"] img`);r&&(r.src=s.target.result),c("image",e,i)},t.readAsDataURL(e)}function c(i,e,t=null){n.services||(n.services={}),t?(n.services[t]||(n.services[t]={}),n.services[t][i]=e):n[i]=e}async function S(){var e;const i=document.getElementById("loadingOverlay");i&&(i.style.display="flex");try{const t=new FormData,s=(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content");s&&t.append("_token",s),n.services&&t.append("services",JSON.stringify(n.services));const o=await(await fetch(window.location.href,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}})).json();o.success?(showNotification("Изменения успешно сохранены","success"),setTimeout(()=>{window.location.reload()},1e3)):showNotification(o.message||"Произошла ошибка при сохранении","error")}catch(t){console.error("Ошибка при сохранении:",t),showNotification("Произошла ошибка при сохранении изменений","error")}finally{i&&(i.style.display="none")}}function L(i){const e=document.querySelector(`.service-price[data-service-id="${i}"]`),t=document.querySelector(`.add-price-button[data-service-id="${i}"]`);if(!e||!t)return;e.style.display!=="none"?(e.style.display="none",t.innerHTML='<i class="bi bi-plus"></i> Цена',t.classList.remove("btn-outline-danger"),t.classList.add("btn-outline-success"),c("hasPrice",!1,i)):(e.style.display="block",t.innerHTML='<i class="bi bi-dash"></i> Убрать',t.classList.remove("btn-outline-success"),t.classList.add("btn-outline-danger"),c("hasPrice",!0,i))}window.initServicePage=u;window.validateServiceForm=l;window.initializeSwiper=m;window.bindEvents=p;window.saveAllChanges=S;window.togglePrice=L;document.addEventListener("DOMContentLoaded",function(){document.getElementById("service-form")&&u(),document.querySelector(".services-swiper")&&(m(),p())});
