let r=null,i={};function m(e={}){i={title:"",excerpt:"",content:"",metaTitle:"",metaDescription:"",metaKeywords:"",hasMetadata:!1,isPublished:!0,publishedAt:"",...e},g(),h(),i.hasMetadata&&(document.querySelector(".article-metadata").style.display="block",f(!0))}function g(){document.querySelector(".articles-swiper")&&new Swiper(".articles-swiper",{slidesPerView:1,spaceBetween:20,loop:!1,navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},pagination:{el:".swiper-pagination",clickable:!0},breakpoints:{768:{slidesPerView:2,spaceBetween:30},1024:{slidesPerView:3,spaceBetween:40}}})}function h(){document.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.addEventListener("input",b),l.addEventListener("blur",w),l.addEventListener("paste",y),l.addEventListener("keydown",E)});const t=document.getElementById("article-image-input");t&&t.addEventListener("change",l=>{handleImageSelect(l,"article-image-preview",(p,A)=>{r=p,c()})});const a=document.getElementById("article-form");a&&a.addEventListener("submit",T);const o=document.getElementById("is-published");o&&o.addEventListener("change",function(){i.isPublished=this.checked,L(this.checked)});const n=document.getElementById("published-at");n&&n.addEventListener("change",function(){i.publishedAt=this.value})}function b(e){const t=e.target,a=t.getAttribute("data-field");if(a&&i.hasOwnProperty(a)){if(i[a]=t.textContent.trim(),a==="title"&&!i.metaTitle){const o=document.querySelector('[data-field="metaTitle"]');if(o&&o.textContent.trim()===""){const n=u(t.textContent.trim(),60);o.textContent=n,i.metaTitle=n}}if(a==="excerpt"&&!i.metaDescription){const o=document.querySelector('[data-field="metaDescription"]');if(o&&o.textContent.trim()===""){const n=u(t.textContent.trim(),160);o.textContent=n,i.metaDescription=n}}a==="metaTitle"&&d(t,60,"Мета-заголовок слишком длинный"),a==="metaDescription"&&d(t,160,"Мета-описание слишком длинное")}}function w(e){const t=e.target,a=t.getAttribute("data-field");a==="title"&&t.textContent.trim().length<5&&(t.classList.add("is-invalid"),showNotification("Заголовок статьи должен содержать минимум 5 символов","warning"),setTimeout(()=>t.classList.remove("is-invalid"),3e3)),a==="content"&&t.textContent.trim().length<50&&(t.classList.add("is-invalid"),showNotification("Содержание статьи должно содержать минимум 50 символов","warning"),setTimeout(()=>t.classList.remove("is-invalid"),3e3))}function y(e){const t=e.target,a=t.getAttribute("data-field");if(a==="content")setTimeout(()=>{v(t),i[a]=t.innerHTML},0);else{e.preventDefault();const o=(e.clipboardData||window.clipboardData).getData("text"),n=window.getSelection();if(!n.rangeCount)return;n.deleteFromDocument(),n.getRangeAt(0).insertNode(document.createTextNode(o)),n.collapseToEnd(),i[a]=t.textContent.trim()}}function E(e){e.target.getAttribute("data-field")==="content"&&(e.ctrlKey&&e.key==="b"&&(e.preventDefault(),document.execCommand("bold",!1,null)),e.ctrlKey&&e.key==="i"&&(e.preventDefault(),document.execCommand("italic",!1,null)),e.ctrlKey&&e.key==="u"&&(e.preventDefault(),document.execCommand("underline",!1,null)))}function v(e){const t=["b","strong","i","em","u","br","p","h1","h2","h3","h4","ul","ol","li"];e.querySelectorAll("*").forEach(o=>{t.includes(o.tagName.toLowerCase())?Array.from(o.attributes).forEach(n=>{o.removeAttribute(n.name)}):o.outerHTML=o.innerHTML})}function d(e,t,a){const o=e.textContent.trim().length;if(o>t){e.classList.add("text-warning");const n=t-o;showNotification(`${a} (${n} символов превышено)`,"warning")}else e.classList.remove("text-warning")}function u(e,t){return e.length<=t?e:e.substring(0,t).trim()+"..."}function L(e){const t=document.getElementById("publish-date-field");t&&(t.style.display=e?"block":"none")}function f(e){const t=document.getElementById("metadata-toggle");t&&(e?(t.innerHTML='<i class="bi bi-dash"></i> Скрыть SEO',t.className="btn btn-outline-danger btn-sm"):(t.innerHTML='<i class="bi bi-plus"></i> Показать SEO',t.className="btn btn-outline-success btn-sm"))}async function T(e){var o;if(e.preventDefault(),!s())return;c();const t=new FormData;Object.keys(i).forEach(n=>{i[n]!==null&&i[n]!==void 0&&t.append(n,i[n])}),r&&t.append("image",r);const a=(o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content");a&&t.append("_token",a),await submitForm(e.target,{method:"POST",loadingOverlayId:"loadingOverlay",validateBeforeSubmit:s,onSuccess:n=>{n.redirect_url&&(window.location.href=n.redirect_url)}})}function c(){document.querySelectorAll('[contenteditable="true"]').forEach(n=>{const l=n.getAttribute("data-field");l&&i.hasOwnProperty(l)&&(l==="content"?i[l]=n.innerHTML:i[l]=n.textContent.trim())});const t=document.querySelector(".article-metadata");i.hasMetadata=t&&t.style.display!=="none";const a=document.getElementById("is-published");a&&(i.isPublished=a.checked);const o=document.getElementById("published-at");o&&(i.publishedAt=o.value)}function s(){if(c(),!i.title||i.title.trim()===""){showNotification("Пожалуйста, введите заголовок статьи","error");const e=document.querySelector('[data-field="title"]');return e&&(e.focus(),e.classList.add("is-invalid"),setTimeout(()=>e.classList.remove("is-invalid"),3e3)),!1}if(i.title.trim().length<5)return showNotification("Заголовок статьи должен содержать минимум 5 символов","error"),!1;if(!i.excerpt||i.excerpt.trim()===""){showNotification("Пожалуйста, введите краткое описание статьи","error");const e=document.querySelector('[data-field="excerpt"]');return e&&(e.focus(),e.classList.add("is-invalid"),setTimeout(()=>e.classList.remove("is-invalid"),3e3)),!1}if(!i.content||i.content.trim()===""){showNotification("Пожалуйста, введите содержание статьи","error");const e=document.querySelector('[data-field="content"]');return e&&(e.focus(),e.classList.add("is-invalid"),setTimeout(()=>e.classList.remove("is-invalid"),3e3)),!1}if(i.content.trim().length<50)return showNotification("Содержание статьи должно содержать минимум 50 символов","error"),!1;if(i.hasMetadata){if(i.metaTitle&&i.metaTitle.length>60)return showNotification("Мета-заголовок не должен превышать 60 символов","error"),!1;if(i.metaDescription&&i.metaDescription.length>160)return showNotification("Мета-описание не должно превышать 160 символов","error"),!1}return!0}window.initArticlePage=m;window.validateArticleForm=s;window.updateMetadataToggleButton=f;document.addEventListener("DOMContentLoaded",function(){document.getElementById("article-form")&&m()});
