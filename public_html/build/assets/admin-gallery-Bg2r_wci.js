let o=[],r={};function m(t={}){r={title:"",description:"",images:[],...t},p(),h()}function p(){document.querySelector(".gallery-swiper")&&new Swiper(".gallery-swiper",{slidesPerView:1,spaceBetween:20,loop:!0,autoplay:{delay:5e3,disableOnInteraction:!1},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},pagination:{el:".swiper-pagination",clickable:!0,dynamicBullets:!0},effect:"fade",fadeEffect:{crossFade:!0},breakpoints:{768:{slidesPerView:2,effect:"slide",spaceBetween:30},1024:{slidesPerView:3,effect:"slide",spaceBetween:40}}})}function h(){document.querySelectorAll('[contenteditable="true"]').forEach(n=>{n.addEventListener("input",w),n.addEventListener("blur",v)});const e=document.getElementById("images-input");e&&e.addEventListener("change",y);const i=document.getElementById("gallery-form");i&&i.addEventListener("submit",E),document.addEventListener("click",function(n){if(n.target.closest(".remove-image-btn")){n.preventDefault();const a=parseInt(n.target.closest(".remove-image-btn").getAttribute("data-index"));f(a)}})}function w(t){const e=t.target,i=e.getAttribute("data-field");i&&r.hasOwnProperty(i)&&(r[i]=e.textContent.trim())}function v(t){const e=t.target;e.getAttribute("data-field")==="title"&&e.textContent.trim().length<3&&(e.classList.add("is-invalid"),showNotification("Название галереи должно содержать минимум 3 символа","warning"),setTimeout(()=>e.classList.remove("is-invalid"),3e3))}function y(t){const e=Array.from(t.target.files);if(e.length===0)return;const i=[],n=10*1024*1024,a=["image/jpeg","image/jpg","image/png","image/webp"];if(e.forEach(c=>{if(!a.includes(c.type)){showNotification(`Файл ${c.name} имеет неподдерживаемый формат`,"error");return}if(c.size>n){showNotification(`Файл ${c.name} слишком большой (максимум 10MB)`,"error");return}i.push(c)}),i.length===0)return;const l=o.length,s=20;l+i.length>s&&(showNotification(`Можно загрузить максимум ${s} изображений. Выбрано только первые ${s-l} файлов.`,"warning"),i.splice(s-l)),i.forEach(c=>{o.push(c)}),u(),showNotification(`Добавлено ${i.length} изображений`,"success")}function u(){const t=document.getElementById("gallery-preview");if(t){if(t.innerHTML="",o.length===0){t.innerHTML='<div class="text-muted text-center py-4">Изображения не выбраны</div>';return}o.forEach((e,i)=>{const n=new FileReader;n.onload=function(a){const l=`
                <div class="gallery-image-item position-relative mb-3" data-index="${i}">
                    <img src="${a.target.result}" alt="Превью ${i+1}" class="img-thumbnail">
                    <button type="button" class="btn btn-danger btn-sm remove-image-btn position-absolute" 
                            data-index="${i}" title="Удалить изображение">
                        <i class="bi bi-x"></i>
                    </button>
                    <div class="image-info">
                        <small class="text-muted">${e.name} (${b(e.size)})</small>
                    </div>
                </div>
            `,s=document.createElement("div");s.innerHTML=l,t.appendChild(s.firstElementChild)},n.readAsDataURL(e)})}}function f(t){if(t>=0&&t<o.length){const e=o[t].name;o.splice(t,1),u(),showNotification(`Изображение ${e} удалено`,"info")}}function b(t){if(t===0)return"0 Bytes";const e=1024,i=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(1))+" "+i[n]}async function E(t){var n;if(t.preventDefault(),!d())return;g();const e=new FormData;Object.keys(r).forEach(a=>{a!=="images"&&r[a]!==null&&r[a]!==void 0&&e.append(a,r[a])}),o.forEach((a,l)=>{e.append(`images[${l}]`,a)});const i=(n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content");i&&e.append("_token",i),await submitForm(t.target,{method:"POST",loadingOverlayId:"loadingOverlay",validateBeforeSubmit:d,onSuccess:a=>{a.redirect_url&&(window.location.href=a.redirect_url)}})}function g(){document.querySelectorAll('[contenteditable="true"]').forEach(e=>{const i=e.getAttribute("data-field");i&&r.hasOwnProperty(i)&&(r[i]=e.textContent.trim())}),r.images=o}function d(){if(g(),!r.title||r.title.trim()===""){showNotification("Пожалуйста, введите название галереи","error");const e=document.querySelector('[data-field="title"]');return e&&(e.focus(),e.classList.add("is-invalid"),setTimeout(()=>e.classList.remove("is-invalid"),3e3)),!1}if(r.title.trim().length<3)return showNotification("Название галереи должно содержать минимум 3 символа","error"),!1;if(!r.description||r.description.trim()===""){showNotification("Пожалуйста, введите описание галереи","error");const e=document.querySelector('[data-field="description"]');return e&&(e.focus(),e.classList.add("is-invalid"),setTimeout(()=>e.classList.remove("is-invalid"),3e3)),!1}return!document.querySelector('[data-edit-mode="true"]')&&o.length===0?(showNotification("Пожалуйста, выберите хотя бы одно изображение для галереи","error"),!1):!0}window.initGalleryPage=m;window.validateGalleryForm=d;window.removeGalleryImage=f;document.addEventListener("DOMContentLoaded",function(){document.getElementById("gallery-form")&&m()});
