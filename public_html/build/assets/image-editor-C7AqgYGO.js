class x{constructor(){this.canvas=null,this.ctx=null,this.image=null,this.scale=1,this.offsetX=0,this.offsetY=0,this.isDragging=!1,this.isResizing=!1,this.dragStart={x:0,y:0},this.cropType="square",this.cropArea={x:0,y:0,width:200,height:200},this.originalImageData=null,this.currentImageType=null,this.init()}init(){this.canvas=document.getElementById("imageCanvas"),this.ctx=this.canvas.getContext("2d"),this.bindEvents(),this.setupCanvas()}bindEvents(){document.getElementById("imageInput").addEventListener("change",t=>{this.handleFileSelect(t)}),document.getElementById("saveImageBtn").addEventListener("click",()=>{this.saveImage()}),this.bindCanvasEvents(),this.bindCropEvents()}bindCanvasEvents(){this.canvas.addEventListener("mousedown",t=>{this.startDrag(t.clientX,t.clientY)}),this.canvas.addEventListener("mousemove",t=>{this.isDragging&&this.drag(t.clientX,t.clientY)}),this.canvas.addEventListener("mouseup",()=>{this.endDrag()}),this.canvas.addEventListener("touchstart",t=>{t.preventDefault();const e=t.touches[0];this.startDrag(e.clientX,e.clientY)}),this.canvas.addEventListener("touchmove",t=>{if(t.preventDefault(),this.isDragging){const e=t.touches[0];this.drag(e.clientX,e.clientY)}}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.endDrag()}),this.canvas.addEventListener("contextmenu",t=>{t.preventDefault()})}bindCropEvents(){const t=document.getElementById("cropCenter");document.getElementById("cropArea"),t.addEventListener("mousedown",e=>{this.startCropDrag(e)}),t.addEventListener("touchstart",e=>{e.preventDefault(),this.startCropDrag(e)}),document.querySelectorAll(".crop-handle").forEach(e=>{e.addEventListener("mousedown",s=>{this.startCropResize(s,e)}),e.addEventListener("touchstart",s=>{s.preventDefault(),this.startCropResize(s,e)})})}setupCanvas(){const t=window.innerWidth,e=window.innerHeight,s=60,n=60;this.canvas.width=t-40,this.canvas.height=e-s-n-40}handleFileSelect(t){const e=t.target.files[0];if(!e)return;if(!e.type.startsWith("image/")){alert("Пожалуйста, выберите файл изображения.");return}const s=new FileReader;s.onload=n=>{this.loadImage(n.target.result)},s.readAsDataURL(e)}loadImage(t){this.image=new Image,this.image.onload=()=>{this.originalImageData=t,this.resetView(),this.showEditor()},this.image.src=t}showEditor(){document.getElementById("fileUploadArea").style.display="none",document.getElementById("imageEditorWorkspace").style.display="block",document.getElementById("saveImageBtn").style.display="inline-block"}hideEditor(){document.getElementById("fileUploadArea").style.display="flex",document.getElementById("imageEditorWorkspace").style.display="none",document.getElementById("saveImageBtn").style.display="none"}resetView(){if(!this.image)return;const t=this.canvas.width,e=this.canvas.height,s=this.image.width,n=this.image.height,a=t/s,i=e/n;this.scale=Math.min(a,i)*.9,this.offsetX=(t-s*this.scale)/2,this.offsetY=(e-n*this.scale)/2,this.updateCropArea(),this.draw()}setCropType(t){this.cropType=t,this.updateCropArea()}updateCropArea(){document.getElementById("cropOverlay");const t=document.getElementById("cropArea"),e=this.canvas.getBoundingClientRect(),s=e.width/2,n=e.height/2;let a,i;this.cropType==="square"?a=i=Math.min(e.width,e.height)*.6:(a=e.width*.8,i=a*(9/16),i>e.height*.8&&(i=e.height*.8,a=i*(16/9))),this.cropArea={x:s-a/2,y:n-i/2,width:a,height:i},t.style.left=this.cropArea.x+"px",t.style.top=this.cropArea.y+"px",t.style.width=this.cropArea.width+"px",t.style.height=this.cropArea.height+"px"}startDrag(t,e){this.isDragging=!0;const s=this.canvas.getBoundingClientRect();this.dragStart={x:t-s.left-this.offsetX,y:e-s.top-this.offsetY}}drag(t,e){if(!this.isDragging)return;const s=this.canvas.getBoundingClientRect();this.offsetX=t-s.left-this.dragStart.x,this.offsetY=e-s.top-this.dragStart.y,this.draw()}endDrag(){this.isDragging=!1}startCropDrag(t){t.preventDefault(),t.stopPropagation(),document.getElementById("cropOverlay").getBoundingClientRect();const e=t.type.includes("touch")?t.touches[0].clientX:t.clientX,s=t.type.includes("touch")?t.touches[0].clientY:t.clientY;this.cropDragStart={x:e-this.cropArea.x,y:s-this.cropArea.y};const n=i=>{const l=i.type.includes("touch")?i.touches[0].clientX:i.clientX,h=i.type.includes("touch")?i.touches[0].clientY:i.clientY;this.cropArea.x=l-this.cropDragStart.x,this.cropArea.y=h-this.cropDragStart.y,this.updateCropAreaPosition()},a=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),document.removeEventListener("touchmove",n),document.removeEventListener("touchend",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a),document.addEventListener("touchmove",n,{passive:!1}),document.addEventListener("touchend",a)}startCropResize(t,e){t.preventDefault(),t.stopPropagation();const s=e.className,n=t.type.includes("touch")?t.touches[0].clientX:t.clientX,a=t.type.includes("touch")?t.touches[0].clientY:t.clientY,i={...this.cropArea},l=n,h=a,d=c=>{const o=c.type.includes("touch")?c.touches[0].clientX:c.clientX,v=c.type.includes("touch")?c.touches[0].clientY:c.clientY,g=o-l,m=v-h;let y=i.x,f=i.y,u=i.width,p=i.height;s.includes("nw")?(y=i.x+g,f=i.y+m,u=i.width-g,p=i.height-m):s.includes("ne")?(f=i.y+m,u=i.width+g,p=i.height-m):s.includes("sw")?(y=i.x+g,u=i.width-g,p=i.height+m):s.includes("se")&&(u=i.width+g,p=i.height+m);const w=50;if(u>=w&&p>=w){if(this.cropType==="square"){const I=Math.min(u,p);this.cropArea.width=I,this.cropArea.height=I}else this.cropArea.width=u,this.cropArea.height=p;this.cropArea.x=y,this.cropArea.y=f,this.updateCropAreaPosition()}},r=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",r),document.removeEventListener("touchmove",d),document.removeEventListener("touchend",r)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",r),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("touchend",r)}updateCropAreaPosition(){const t=document.getElementById("cropArea");t.style.left=this.cropArea.x+"px",t.style.top=this.cropArea.y+"px",t.style.width=this.cropArea.width+"px",t.style.height=this.cropArea.height+"px"}draw(){this.image&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.image,this.offsetX,this.offsetY,this.image.width*this.scale,this.image.height*this.scale))}saveImage(){if(!this.image)return;const t=this.canvas.getBoundingClientRect(),e=this.canvas.width/t.width,s=this.canvas.height/t.height,n=this.cropArea.x*e,a=this.cropArea.y*s,i=this.cropArea.width*e,l=this.cropArea.height*s,h=document.createElement("canvas"),d=h.getContext("2d");let r,c;this.cropType==="square"?r=c=400:(r=1200,c=675),h.width=r,h.height=c,this.image.width*this.scale,this.image.height*this.scale;const o=Math.max(0,(n-this.offsetX)/this.scale),v=Math.max(0,(a-this.offsetY)/this.scale),g=Math.min(this.image.width-o,i/this.scale),m=Math.min(this.image.height-v,l/this.scale);d.drawImage(this.image,o,v,g,m,0,0,r,c);const y=h.toDataURL("image/jpeg",.9);this.uploadCroppedImage(y)}uploadCroppedImage(t){document.getElementById("croppedImageForm"),document.getElementById("croppedImageData"),document.getElementById("imageType");const e=atob(t.split(",")[1]),s=t.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(e.length),a=new Uint8Array(n);for(let o=0;o<e.length;o++)a[o]=e.charCodeAt(o);const i=new Blob([n],{type:s}),l=new FormData;this.currentImageType==="avatar"?l.append("avatar",i,"avatar.jpg"):l.append("background_image",i,"background.jpg");const h=window.location.pathname.split("/")[2]||window.pageUsername;let d;this.currentImageType==="avatar"?d=`/user/${h}/update-avatar`:d=`/user/${h}/update-background`;const r=document.getElementById("saveImageBtn"),c=r.innerHTML;r.innerHTML='<i class="bi bi-arrow-repeat spin me-2"></i>Сохранение...',r.disabled=!0,fetch(d,{method:"POST",body:l,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"X-Requested-With":"XMLHttpRequest"}}).then(o=>o.json()).then(o=>{if(o.success)bootstrap.Modal.getInstance(document.getElementById("imageEditorModal")).hide(),this.updatePageImage(o.image_url),this.showSuccessMessage("Изображение успешно обновлено!");else throw new Error(o.message||"Ошибка при сохранении изображения")}).catch(o=>{console.error("Ошибка:",o),this.showErrorMessage("Ошибка при сохранении изображения: "+o.message)}).finally(()=>{r.innerHTML=c,r.disabled=!1})}updatePageImage(t){if(this.currentImageType==="avatar")document.querySelectorAll(".hero-logo img, #avatar-editable img").forEach(s=>{s.src=t+"?t="+Date.now()});else{const e=document.querySelector(".hero, #hero-background-editable");e&&(e.style.backgroundImage=`url('${t}?t=${Date.now()}')`)}}showSuccessMessage(t){this.showMessage(t,"success")}showErrorMessage(t){this.showMessage(t,"danger")}showMessage(t,e){const s=document.createElement("div");s.className=`alert alert-${e} alert-dismissible fade show position-fixed`,s.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",s.innerHTML=`
            ${t}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.remove()},5e3)}openEditor(t){this.currentImageType=t,this.hideEditor(),document.getElementById("imageInput").value="",this.cropType=t==="avatar"?"square":"rectangle";const e=document.getElementById("imageEditorModalLabel");e.textContent=t==="avatar"?"Редактирование аватара":"Редактирование фона",this.setupCanvas(),new bootstrap.Modal(document.getElementById("imageEditorModal")).show()}}document.addEventListener("DOMContentLoaded",function(){window.imageEditor=new x;const E=new CustomEvent("imageEditorReady");document.dispatchEvent(E),console.log("Image editor initialized and ready")});const A=document.createElement("style");A.textContent=`
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;document.head.appendChild(A);
